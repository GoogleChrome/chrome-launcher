<!doctype html>
<!--
 * Copyright 2017 Google Inc. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->
<html>
<head>
<title>Byte Efficency tester</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<script>
function generateInlineScriptWithSize(sizeInBytes, firstContent = '', used = false) {
  const data = [];
  while (sizeInBytes > 0) {
    const index = Math.round(100000 * Math.random());
    const className = `${used ? '' : 'un'}used-selector${index}`;
    const rule = `.${className} { background: white; }`;
    data.push(rule);
    if (used) {
      const div = document.createElement('div');
      div.classList.add(className);
      document.body.appendChild(div);
    }
    sizeInBytes -= rule.length / 3; // 1 byte per character, GZip estimate is 3x
  }

  const style = document.createElement('style');
  const textContent = firstContent + data.join('\n');
  style.appendChild(document.createTextNode(textContent));
  document.head.appendChild(style);
}

// Lazily load the image
setTimeout(() => {
  const template = document.getElementById('lazily-loaded-image');
  document.body.appendChild(template.content.cloneNode(true));
}, 6000);
</script>
<style>
  .onscreen {
    position: absolute;
    top: 0;
    left: 0;
  }
</style>
</head>

<body>

<div>
  <h2>Byte efficiency tester page</h2>
  <span>Hi there!</span>
</div>

<div class="images">
  <!-- FAIL(optimized): image is not JPEG optimized -->
  <!-- FAIL(webp): image is not WebP optimized -->
  <!-- PASS(responsive): image is used at full size -->
  <!-- FAIL(offscreen): image is offscreen -->
  <img style="position: absolute; top: -10000px;" src="lighthouse-unoptimized.jpg">

  <!-- Image is cross-origin, which are disabled for now -->
  <!-- FAIL(optimized): image is not optimized -->
  <!-- FAIL(webp): image is not WebP optimized -->
  <!-- PASS(responsive): image is used at full size -->
  <!--<img src="http://localhost:10503/byte-efficiency/lighthouse-unoptimized.jpg">-->

  <!-- PASS(optimized): image is JPEG optimized -->
  <!-- FAIL(webp): image is not WebP optimized -->
  <!-- FAIL(responsive): image is 25% used at DPR 2 -->
  <!-- PASS(offscreen): image is onscreen -->
  <img style="width: 256px; height: 170px;" src="lighthouse-1024x680.jpg">

  <!-- PASS(optimized): image is JPEG optimized -->
  <!-- FAIL(webp): image is not WebP optimized -->
  <!-- PASS(responsive): image is fully used at DPR 2 -->
  <!-- PASS(offscreen): image is onscreen -->
  <img style="width: 240px; height: 160px;" src="lighthouse-480x320.jpg">

  <!-- PASS(optimized): image is JPEG optimized -->
  <!-- PASS(webp): image has insigificant WebP savings -->
  <!-- PASS(responsive): image is used at full size -->
  <!-- PASS(offscreen): image is onscreen -->
  <img src="lighthouse-320x212-poor.jpg">

  <!-- PASS(optimized): image is JPEG optimized -->
  <!-- PASS(webp): image is WebP optimized -->
  <!-- PASSWARN(responsive): image is 25% used at DPR 2 (but small savings) -->
  <!-- FAIL(offscreen): image is offscreen -->
  <img style="margin-top: 1000px; width: 120px; height: 80px;" src="lighthouse-480x320.webp">

  <!-- PASS(optimized): image is vector -->
  <!-- PASS(webp): image is vector -->
  <!-- PASS(responsive): image is vector -->
  <!-- FAIL(offscreen): image is offscreen -->
  <img style="width: 100px; height: 100px;" src="large.svg">

  <!-- PASS(optimized): image is JPEG optimized -->
  <!-- PASS(webp): image has insigificant WebP savings -->
  <!-- PASS(responsive): image is later used at full size -->
  <!-- PASS(offscreen): image is later used onscreen -->
  <img style="width: 24px; height: 16px;"src="lighthouse-320x212-poor.jpg?duplicate">

  <!-- PASS(optimized): image is JPEG optimized -->
  <!-- PASS(webp): image has insigificant WebP savings -->
  <!-- PASS(responsive): image is used at full size -->
  <!-- PASS(offscreen): image is onscreen -->
  <img class="onscreen" src="lighthouse-320x212-poor.jpg?duplicate">

  <!-- PASS(optimized): image is WebP -->
  <!-- PASS(webp): image is WebP optimized -->
  <!-- FAIL(responsive): image is used at 1/16 size -->
  <!-- PASS(offscreen): image is onscreen -->
  <div class="onscreen" style="width: 120px; height: 80px; background: 50% 50% url(lighthouse-480x320.webp?css);"></div>

  <!-- PASS(optimized): image is JPEG optimized -->
  <!-- FAIL(webp): image is not WebP optimized -->
  <!-- PASS(responsive): image is used numerous times in sprite-fashion -->
  <!-- PASS(offscreen): image is onscreen -->
  <div class="onscreen" style="width: 30px; height: 30px; background: 0% 50% url(lighthouse-480x320.jpg?sprite);"></div>
  <div class="onscreen" style="width: 30px; height: 30px; background: 25% 50% url(lighthouse-480x320.jpg?sprite);"></div>
  <div class="onscreen" style="width: 30px; height: 30px; background: 50% 50% url(lighthouse-480x320.jpg?sprite);"></div>
  <div class="onscreen" style="width: 30px; height: 30px; background: 75% 50% url(lighthouse-480x320.jpg?sprite);"></div>
</div>

<template id="lazily-loaded-image">
  <!-- PASS(optimized): image is WebP -->
  <!-- PASS(responsive): image is used at full size -->
  <!-- PASS(offscreen): image is lazily loaded after TTI -->
  <img style="position: absolute; top: -5000px;" src="lighthouse-480x320.webp?lazilyLoaded=true">
</template>

<script>
// PASS: unused but too small savings
generateInlineScriptWithSize(512, '.too-small { background: none; }\n');
// PASS: used
generateInlineScriptWithSize(4000, '.mostly-used { background: none; }\n', true);
// PASSWARN: unused and a bit of savings
generateInlineScriptWithSize(2000, '.kinda-unused { background: none; }\n');
// FAIL: unused and lots of savings
generateInlineScriptWithSize(24000, '.definitely-unused { background: none; }\n');
</script>

<!-- Ensure the page takes at least 7 seconds and we don't exit before the lazily loaded image -->
<script src="delay-complete.js?delay=7000" async></script>
</body>
</html>
